pipeline {
    agent any
    
    environment {
        DOCKER_REGISTRY = 'localhost:5000'  // Changez selon votre registry
        IMAGE_NAME = 'food-delivery'
        SONAR_HOST = 'http://food-sonarqube:9000'
        GIT_COMMIT_SHORT = ''
        JENKINS_HOME = '/var/jenkins_home'
    }
    
    tools {
        nodejs 'NodeJS-18'
    }
    
    parameters {
        choice(
            name: 'DEPLOY_ENV',
            choices: ['dev', 'staging', 'prod'],
            description: 'Environnement de d√©ploiement'
        )
    }
    
    stages {
        // ==================== √âTAPE 1: CHECKOUT ====================
        stage('üîç Checkout') {
            steps {
                checkout scm
                script {
                    env.GIT_COMMIT_SHORT = sh(
                        script: "git rev-parse --short HEAD",
                        returnStdout: true
                    ).trim()
                    echo "Building commit: ${env.GIT_COMMIT_SHORT}"
                }
            }
        }
        
        // ==================== √âTAPE 2: SETUP ENV ====================
        stage('üîß Setup Environment') {
            steps {
                sh '''
                    echo "=== INSTALLATION DES OUTILS ==="
                    
                    # Installer Node.js si pas d√©j√† install√©
                    if ! command -v node &> /dev/null; then
                        echo "Installation de Node.js 18..."
                        curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
                        apt-get install -y nodejs
                    fi
                    
                    # Installer Docker si pas d√©j√† install√©
                    if ! command -v docker &> /dev/null; then
                        echo "Installation de Docker..."
                        apt-get install -y docker.io docker-compose
                    fi
                    
                    # V√©rifier les versions
                    node --version
                    npm --version
                    docker --version
                    docker-compose --version
                '''
            }
        }
        
        // ==================== √âTAPE 3: INSTALL DEPS ====================
        stage('üì¶ Install Dependencies') {
            parallel {
                stage('Backend') {
                    steps {
                        dir('backend') {
                            sh '''
                                echo "Installation des d√©pendances backend..."
                                npm ci --no-audit --no-fund
                                npm audit --audit-level=high --json > npm-audit-backend.json 2>&1 || true
                            '''
                            archiveArtifacts artifacts: 'npm-audit-backend.json'
                        }
                    }
                }
                
                stage('Frontend') {
                    steps {
                        dir('frontend') {
                            sh '''
                                echo "Installation des d√©pendances frontend..."
                                npm ci --no-audit --no-fund
                                npm audit --audit-level=high --json > npm-audit-frontend.json 2>&1 || true
                            '''
                            archiveArtifacts artifacts: 'npm-audit-frontend.json'
                        }
                    }
                }
            }
        }
        
        // ==================== √âTAPE 4: SAST (SonarQube) ====================
        stage('üî¨ SAST - SonarQube Analysis') {
            steps {
                script {
                    // D√©marrer SonarQube s'il n'est pas d√©j√† d√©marr√©
                    sh '''
                        echo "D√©marrage de SonarQube pour analyse SAST..."
                        docker-compose up -d sonarqube || true
                        sleep 30  # Attendre que SonarQube d√©marre
                    '''
                    
                    withSonarQubeEnv('SonarQube') {
                        sh '''
                            echo "Ex√©cution de l'analyse SonarQube..."
                            sonar-scanner \
                                -Dsonar.projectKey=food-delivery \
                                -Dsonar.projectName="Food Delivery App" \
                                -Dsonar.projectVersion=1.0 \
                                -Dsonar.sources=backend,frontend/src \
                                -Dsonar.exclusions="**/node_modules/**,**/dist/**,**/*.test.js,**/*.spec.js" \
                                -Dsonar.javascript.lcov.reportPaths=backend/coverage/lcov.info,frontend/coverage/lcov.info \
                                -Dsonar.sourceEncoding=UTF-8 \
                                -Dsonar.host.url=${SONAR_HOST} \
                                -Dsonar.login=${SONAR_TOKEN} \
                                -Dsonar.qualitygate.wait=true
                        '''
                    }
                }
            }
        }
        
        // ==================== √âTAPE 5: QUALITY GATE ====================
        stage('üéØ Quality Gate') {
            steps {
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }
        
        // ==================== √âTAPE 6: OWASP DEPENDENCY CHECK ====================
        stage('üìã OWASP Dependency Check') {
            steps {
                dependencyCheck additionalArguments: '''
                    --scan . \
                    --format HTML \
                    --format JSON \
                    --prettyPrint \
                    --out reports/dependency-check
                ''', odcInstallation: 'OWASP-DC'
                
                dependencyCheckPublisher pattern: 'reports/dependency-check/dependency-check-report.json'
                
                publishHTML([
                    reportDir: 'reports/dependency-check',
                    reportFiles: 'dependency-check-report.html',
                    reportName: 'OWASP Dependency Check Report',
                    keepAll: true
                ])
            }
        }
        
        // ==================== √âTAPE 7: TESTS UNITAIRES ====================
        stage('üß™ Unit Tests') {
            parallel {
                stage('Backend Tests') {
                    steps {
                        dir('backend') {
                            sh '''
                                echo "Ex√©cution des tests backend..."
                                npm test -- --coverage --watchAll=false --testPathIgnorePatterns=node_modules
                            '''
                        }
                    }
                    post {
                        always {
                            publishHTML([
                                reportDir: 'backend/coverage/lcov-report',
                                reportFiles: 'index.html',
                                reportName: 'Backend Test Coverage Report',
                                keepAll: true
                            ])
                        }
                    }
                }
                
                stage('Frontend Tests') {
                    steps {
                        dir('frontend') {
                            sh '''
                                echo "Ex√©cution des tests frontend..."
                                npm test -- --coverage --watchAll=false --testPathIgnorePatterns=node_modules
                            '''
                        }
                    }
                    post {
                        always {
                            publishHTML([
                                reportDir: 'frontend/coverage/lcov-report',
                                reportFiles: 'index.html',
                                reportName: 'Frontend Test Coverage Report',
                                keepAll: true
                            ])
                        }
                    }
                }
            }
        }
        
        // ==================== √âTAPE 8: BUILD DOCKER IMAGES ====================
        stage('üê≥ Build Docker Images') {
            steps {
                script {
                    echo "Construction des images Docker..."
                    
                    // Backend
                    sh '''
                        docker build \
                            -t ${DOCKER_REGISTRY}/${IMAGE_NAME}-backend:${GIT_COMMIT_SHORT} \
                            -t ${DOCKER_REGISTRY}/${IMAGE_NAME}-backend:latest \
                            ./backend
                    '''
                    
                    // Frontend
                    sh '''
                        docker build \
                            -t ${DOCKER_REGISTRY}/${IMAGE_NAME}-frontend:${GIT_COMMIT_SHORT} \
                            -t ${DOCKER_REGISTRY}/${IMAGE_NAME}-frontend:latest \
                            ./frontend
                    '''
                    
                    // Lister les images
                    sh 'docker images | grep food-delivery'
                }
            }
        }
        
        // ==================== √âTAPE 9: CONTAINER SECURITY SCAN ====================
        stage('üîí Container Security Scan (Trivy)') {
            steps {
                sh '''
                    echo "Installation de Trivy..."
                    # Installation de Trivy
                    wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | apt-key add -
                    echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | tee -a /etc/apt/sources.list.d/trivy.list
                    apt-get update
                    apt-get install -y trivy
                    
                    echo "Scan de l'image backend..."
                    trivy image \
                        --severity HIGH,CRITICAL \
                        --format json \
                        --output trivy-backend.json \
                        ${DOCKER_REGISTRY}/${IMAGE_NAME}-backend:${GIT_COMMIT_SHORT} || true
                    
                    echo "Scan de l'image frontend..."
                    trivy image \
                        --severity HIGH,CRITICAL \
                        --format json \
                        --output trivy-frontend.json \
                        ${DOCKER_REGISTRY}/${IMAGE_NAME}-frontend:${GIT_COMMIT_SHORT} || true
                    
                    # G√©n√©rer des rapports HTML
                    trivy image \
                        --severity HIGH,CRITICAL \
                        --format template \
                        --template "@/usr/local/share/trivy/templates/html.tpl" \
                        --output trivy-backend.html \
                        ${DOCKER_REGISTRY}/${IMAGE_NAME}-backend:${GIT_COMMIT_SHORT} || true
                        
                    trivy image \
                        --severity HIGH,CRITICAL \
                        --format template \
                        --template "@/usr/local/share/trivy/templates/html.tpl" \
                        --output trivy-frontend.html \
                        ${DOCKER_REGISTRY}/${IMAGE_NAME}-frontend:${GIT_COMMIT_SHORT} || true
                '''
                
                // Archiver les rapports
                archiveArtifacts artifacts: 'trivy-*.json,trivy-*.html'
                
                // Publier les rapports HTML
                publishHTML([
                    reportDir: '.',
                    reportFiles: 'trivy-backend.html',
                    reportName: 'Trivy Backend Scan Report',
                    keepAll: true
                ])
                
                publishHTML([
                    reportDir: '.',
                    reportFiles: 'trivy-frontend.html',
                    reportName: 'Trivy Frontend Scan Report',
                    keepAll: true
                ])
            }
        }
        
        // ==================== √âTAPE 10: D√âPLOIEMENT STAGING ====================
        stage('üöÄ Deploy to Staging') {
            when {
                expression { 
                    params.DEPLOY_ENV == 'staging' || env.BRANCH_NAME == 'develop' 
                }
            }
            steps {
                script {
                    echo "D√©ploiement en environnement staging..."
                    
                    sh '''
                        # Arr√™ter les anciens conteneurs
                        docker-compose down --remove-orphans --volumes --timeout 30 || true
                        
                        # Nettoyage
                        docker container prune -f
                        docker network prune -f
                        
                        # D√©marrer les services
                        docker-compose -f docker-compose.yml -f docker-compose.staging.yml up -d --build --force-recreate
                        
                        # Attendre que les services d√©marrent
                        sleep 30
                        
                        # V√©rifier l'√©tat
                        docker-compose ps
                    '''
                    
                    // Attendre que l'application soit disponible
                    sh '''
                        echo "V√©rification de la sant√© de l'application..."
                        timeout 120 bash -c '
                            while ! curl -f http://localhost:80 > /dev/null 2>&1; do
                                echo "En attente de l'application..."
                                sleep 5
                            done
                        '
                        echo "Application disponible!"
                    '''
                }
            }
        }
        
        // ==================== √âTAPE 11: DAST (OWASP ZAP) ====================
        stage('üõ°Ô∏è DAST - OWASP ZAP Scan') {
            when {
                expression { 
                    params.DEPLOY_ENV == 'staging' || env.BRANCH_NAME == 'develop' 
                }
            }
            steps {
                script {
                    echo "Ex√©cution du scan de s√©curit√© dynamique avec OWASP ZAP..."
                    
                    sh '''
                        # Pull de l'image ZAP
                        docker pull owasp/zap2docker-stable
                        
                        # Scan baseline (passif)
                        docker run --rm \
                            -v ${WORKSPACE}:/zap/wrk:rw \
                            owasp/zap2docker-stable zap-baseline.py \
                            -t http://localhost:80 \
                            -r zap-report.html \
                            -J zap-report.json \
                            -x zap-report.xml \
                            -c zap-rules.conf || true
                        
                        # Scan API si disponible
                        if curl -f http://localhost:80/api-docs 2>/dev/null; then
                            docker run --rm \
                                -v ${WORKSPACE}:/zap/wrk:rw \
                                owasp/zap2docker-stable zap-api-scan.py \
                                -t http://localhost:80/api-docs \
                                -f openapi \
                                -r zap-api-report.html \
                                -J zap-api-report.json || true
                        fi
                    '''
                    
                    // Archiver les rapports
                    archiveArtifacts artifacts: 'zap-*.html,zap-*.json,zap-*.xml'
                    
                    // Publier les rapports HTML
                    publishHTML([
                        reportDir: '.',
                        reportFiles: 'zap-report.html',
                        reportName: 'OWASP ZAP Security Report',
                        keepAll: true
                    ])
                }
            }
        }
        
        // ==================== √âTAPE 12: D√âPLOIEMENT PRODUCTION ====================
        stage('üöÄ Deploy to Production') {
            when {
                expression { 
                    params.DEPLOY_ENV == 'prod' && env.BRANCH_NAME == 'main' 
                }
            }
            steps {
                script {
                    // Demande de confirmation manuelle pour la production
                    input(
                        message: 'Confirmer le d√©ploiement en PRODUCTION?',
                        ok: '‚úÖ D√©ployer en Production'
                    )
                    
                    echo "D√©ploiement en environnement production..."
                    
                    sh '''
                        # Arr√™ter les anciens conteneurs
                        docker-compose -f docker-compose.yml -f docker-compose.prod.yml down --remove-orphans --volumes --timeout 30 || true
                        
                        # Nettoyage complet
                        docker system prune -af --volumes
                        
                        # D√©marrer les services en production
                        docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build --force-recreate
                        
                        # V√©rifier l'√©tat
                        docker-compose -f docker-compose.yml -f docker-compose.prod.yml ps
                        
                        # Attendre et v√©rifier la sant√©
                        sleep 60
                        curl -f http://localhost:80/health || echo "V√©rification de sant√© √©chou√©e"
                    '''
                }
            }
        }
        
        // ==================== √âTAPE 13: MONITORING ====================
        stage('üìä Monitoring Setup') {
            steps {
                sh '''
                    echo "Configuration du monitoring..."
                    
                    # D√©marrer Prometheus et Grafana
                    docker-compose up -d prometheus grafana || true
                    
                    # V√©rifier que les services sont en cours d'ex√©cution
                    echo "Services de monitoring:"
                    docker-compose ps | grep -E "(prometheus|grafana)"
                    
                    # Attendre que Grafana d√©marre
                    sleep 30
                    
                    # Configurer Grafana (exemple basique)
                    echo "URLs de monitoring:"
                    echo "- Prometheus: http://localhost:9090"
                    echo "- Grafana: http://localhost:3000 (admin/admin)"
                '''
            }
        }
    }
    
    post {
        always {
            echo "=== NETTOYAGE FINAL ==="
            
            sh '''
                # Sauvegarder les logs
                echo "Sauvegarde des logs de d√©ploiement..."
                docker-compose logs --tail=100 > deployment-logs.log 2>&1 || true
                
                # √âtat final des conteneurs
                echo "=== √âTAT FINAL DES CONTENEURS ==="
                docker-compose ps -a || true
                docker ps -a || true
                
                # Nettoyer l'espace de travail
                echo "Nettoyage de l'espace de travail..."
                docker system prune -f --volumes || true
            '''
            
            // Sauvegarder les logs
            archiveArtifacts artifacts: 'deployment-logs.log,*.log,*.json,*.html,*.xml'
            
            // Nettoyer l'espace de travail Jenkins
            cleanWs()
        }
        
        success {
            echo "‚úÖ PIPELINE R√âUSSI!"
            
            // Notification Slack (si configur√©)
            script {
                if (env.SLACK_CHANNEL) {
                    slackSend(
                        channel: env.SLACK_CHANNEL,
                        color: 'good',
                        message: "‚úÖ Pipeline SUCCESS: ${env.JOB_NAME} #${env.BUILD_NUMBER}\nCommit: ${env.GIT_COMMIT_SHORT}\nEnvironnement: ${params.DEPLOY_ENV}"
                    )
                }
            }
            
            // Notification email
            emailext (
                subject: "‚úÖ SUCCESS: Pipeline ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """
                    Le pipeline DevSecOps a r√©ussi avec succ√®s!
                    
                    D√©tails:
                    - Job: ${env.JOB_NAME}
                    - Build: #${env.BUILD_NUMBER}
                    - Commit: ${env.GIT_COMMIT_SHORT}
                    - Environnement: ${params.DEPLOY_ENV}
                    - Date: ${new Date()}
                    
                    Rapports disponibles dans Jenkins.
                """,
                to: 'devops@example.com'
            )
        }
        
        failure {
            echo "‚ùå PIPELINE √âCHOU√â!"
            
            // Notification Slack (si configur√©)
            script {
                if (env.SLACK_CHANNEL) {
                    slackSend(
                        channel: env.SLACK_CHANNEL,
                        color: 'danger',
                        message: "‚ùå Pipeline FAILED: ${env.JOB_NAME} #${env.BUILD_NUMBER}\nCommit: ${env.GIT_COMMIT_SHORT}\nEnvironnement: ${params.DEPLOY_ENV}"
                    )
                }
            }
            
            // Notification email
            emailext (
                subject: "‚ùå FAILURE: Pipeline ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """
                    Le pipeline DevSecOps a √©chou√©!
                    
                    D√©tails:
                    - Job: ${env.JOB_NAME}
                    - Build: #${env.BUILD_NUMBER}
                    - Commit: ${env.GIT_COMMIT_SHORT}
                    - Environnement: ${params.DEPLOY_ENV}
                    - Date: ${new Date()}
                    
                    Veuillez v√©rifier les logs Jenkins pour plus de d√©tails.
                """,
                to: 'devops@example.com'
            )
        }
        
        unstable {
            echo "‚ö†Ô∏è PIPELINE INSTABLE!"
        }
        
        aborted {
            echo "‚è∏Ô∏è PIPELINE INTERROMPU!"
        }
    }
}