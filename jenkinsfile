pipeline {
    agent any

    environment {
        DOCKER_REGISTRY = ''
        IMAGE_NAME = 'food-delivery'
        SONAR_HOST = 'http://sonarqube:9000'
    }

    tools {
        nodejs 'NodeJS-18'
    }

    stages {
        stage('üîß Setup Node.js') {
            steps {
                bat """
                    echo Using Node.js from Jenkins tool:
                    echo Node version:
                    %NODEJS_HOME%\\node -v
                    echo NPM version:
                    %NODEJS_HOME%\\npm -v
                """
            }
        }

        stage('üîç Checkout') {
            steps {
                checkout scm
                script {
                    env.GIT_COMMIT_SHORT = bat(
                        script: 'git rev-parse --short HEAD',
                        returnStdout: true
                    ).trim()
                }
            }
        }

        stage('üì¶ Install Dependencies') {
            parallel {
                stage('Backend') {
                    steps {
                        dir('backend') {
                            bat '%NODEJS_HOME%\\npm ci --no-audit'
                        }
                    }
                }
                stage('Frontend') {
                    steps {
                        dir('frontend') {
                            bat '%NODEJS_HOME%\\npm ci --no-audit'
                        }
                    }
                }
            }
        }

        stage('üîê SAST - SonarQube Analysis') {
            steps {
                withSonarQubeEnv('SonarQubeServer') {
                    bat '%SONAR_SCANNER_HOME%\\bin\\sonar-scanner.bat -Dsonar.projectKey=food-delivery -Dsonar.sources=backend,frontend/src -Dsonar.exclusions=**/node_modules/**,**/dist/** -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info'
                }
            }
        }

        stage('üß™ Unit Tests') {
            parallel {
                stage('Backend Tests') {
                    steps {
                        dir('backend') {
                            bat '%NODEJS_HOME%\\npm test -- --coverage --coverageReporters=lcov || exit 0'
                        }
                    }
                }
                stage('Frontend Tests') {
                    steps {
                        dir('frontend') {
                            bat '%NODEJS_HOME%\\npm test -- --coverage --watchAll=false || exit 0'
                        }
                    }
                }
            }
        }

        stage('üìä Publish Test Reports') {
            steps {
                // Backend coverage report
                publishHTML([
                    target: [
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'backend\\coverage\\lcov-report',
                        reportFiles: 'index.html',
                        reportName: 'Backend Coverage'
                    ]
                ])

                // Frontend coverage report
                publishHTML([
                    target: [
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'frontend\\coverage',
                        reportFiles: 'index.html',
                        reportName: 'Frontend Coverage'
                    ]
                ])
            }
        }

        stage('üê≥ Build Docker Images') {
            steps {
                script {
                    bat "docker build -t ${IMAGE_NAME}-backend:${GIT_COMMIT_SHORT} .\\backend"
                    bat "docker build -t ${IMAGE_NAME}-frontend:${GIT_COMMIT_SHORT} .\\frontend"
                }
            }
        }

        stage('üîí Container Security Scan') {
            steps {
                bat """
                    if not exist "%ProgramFiles%\\Trivy\\trivy.exe" (
                        echo Trivy not found, please install Trivy on Windows and add it to PATH
                        exit 0
                    )
                    trivy.exe image --severity HIGH,CRITICAL --format json --output trivy-backend.json ${IMAGE_NAME}-backend:${GIT_COMMIT_SHORT} || exit 0
                    trivy.exe image --severity HIGH,CRITICAL --format json --output trivy-frontend.json ${IMAGE_NAME}-frontend:${GIT_COMMIT_SHORT} || exit 0
                """
                archiveArtifacts artifacts: 'trivy-*.json'
            }
        }

        stage('üéØ DAST - OWASP ZAP') {
            when {
                branch 'develop'
            }
            steps {
                bat """
                    docker run --rm -v %cd%:/zap/wrk:rw owasp/zap2docker-stable zap-baseline.py -t http://localhost:80 -r zap-report.html -J zap-report.json || exit 0
                """
                publishHTML([
                    target: [
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: '.',
                        reportFiles: 'zap-report.html',
                        reportName: 'OWASP ZAP Security Report'
                    ]
                ])
            }
        }

        stage('üöÄ Deploy to Staging') {
            when {
                branch 'develop'
            }
            steps {
                bat """
                    docker-compose -f docker-compose.staging.yml down || exit 0
                    docker-compose -f docker-compose.staging.yml up -d
                """
            }
        }

        stage('üöÄ Deploy to Production') {
            when {
                branch 'main'
            }
            steps {
                input message: 'Deploy to Production?', ok: 'Deploy'
                bat """
                    docker-compose -f docker-compose.prod.yml down || exit 0
                    docker-compose -f docker-compose.prod.yml up -d
                """
            }
        }
    }

    post {
        always {
            cleanWs()
        }
        success {
            echo 'üéâ Pipeline succeeded!'
        }
        failure {
            echo '‚ùå Pipeline failed!'
        }
    }
}
