pipeline {
    agent any
    
    environment {
        IMAGE_NAME = 'food-delivery'
        COMPOSE_FILE = 'docker-compose.yml'
    }
    
    stages {
        stage('üîß Setup Environment') {
            steps {
                sh '''
                    echo "=== SETTING UP ENVIRONMENT ==="
                    
                    if ! command -v node &> /dev/null; then
                        echo "Installing Node.js 18..."
                        apt-get update
                        apt-get install -y curl
                        curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
                        apt-get install -y nodejs
                    fi
                    
                    echo "Node.js version: $(node --version)"
                    echo "npm version: $(npm --version)"
                    
                    if ! command -v docker &> /dev/null; then
                        echo "Installing Docker..."
                        apt-get install -y docker.io
                    fi
                    
                    echo "Docker version: $(docker --version 2>/dev/null || echo "Docker not found")"
                    
                    if ! command -v docker-compose &> /dev/null; then
                        echo "Installing docker-compose..."
                        apt-get install -y docker-compose
                    fi
                    
                    echo "docker-compose version: $(docker-compose --version 2>/dev/null || echo "docker-compose not found")"
                '''
            }
        }
        
        stage('üîç Checkout') {
            steps {
                checkout scm
                script {
                    env.GIT_COMMIT_SHORT = sh(
                        script: "git rev-parse --short HEAD",
                        returnStdout: true
                    ).trim()
                    echo "Building commit: ${env.GIT_COMMIT_SHORT}"
                }
            }
        }
        
        stage('üì¶ Install Dependencies') {
            parallel {
                stage('Backend') {
                    steps {
                        dir('backend') {
                            sh '''
                                echo "Installing backend dependencies..."
                                npm ci --no-audit || npm install || echo "Dependencies installed"
                            '''
                        }
                    }
                }
                stage('Frontend') {
                    steps {
                        dir('frontend') {
                            sh '''
                                echo "Installing frontend dependencies..."
                                npm ci --no-audit || npm install || echo "Dependencies installed"
                            '''
                        }
                    }
                }
            }
        }
        
        stage('üß™ Tests') {
            steps {
                echo "Running tests..."
                dir('backend') {
                    sh 'npm test || echo "No tests in backend"'
                }
                dir('frontend') {
                    sh 'npm test || echo "No tests in frontend"'
                }
            }
        }
        
      stage('üê≥ Build & Deploy') {
    steps {
        sh '''
            echo "üöÄ STARTING FULL DEPLOYMENT PROCESS"
            
            # √âtape 0: V√©rifier les variables d'environnement
            echo "Checking environment variables..."
            if [ ! -f .env ]; then
                echo "Creating .env file from template..."
                echo "MONGO_USER=admin" > .env
                echo "MONGO_PASSWORD=admin123" >> .env
                echo "JWT_SECRET=your-super-secret-jwt-key" >> .env
                echo "NODE_ENV=production" >> .env
            fi
            
            # √âtape 1: Nettoyage radical
            echo "=== RADICAL CLEANUP ==="
            echo "1. Stopping all containers..."
            docker ps -q | xargs -r docker stop 2>/dev/null || echo "No running containers"
            
            echo "2. Removing all containers..."
            docker ps -aq | xargs -r docker rm -f 2>/dev/null || echo "No containers to remove"
            
            echo "3. Force removing our specific containers..."
            for name in food-mongodb food-backend food-frontend food-sonarqube food-prometheus food-grafana food-jenkins; do
                docker rm -f $name 2>/dev/null || true
            done
            
            echo "4. Cleaning networks and volumes..."
            docker network prune -f 2>/dev/null || true
            docker volume prune -f 2>/dev/null || true
            
            # √âtape 2: Construction
            echo "=== BUILDING IMAGES ==="
            docker-compose build --no-cache
            
            # √âtape 3: D√©ploiement
            echo "=== DEPLOYING SERVICES ==="
            docker-compose up -d
            
            # √âtape 4: V√©rification
            echo "=== VERIFICATION ==="
            echo "Waiting 30 seconds for services to start..."
            sleep 30
            
            echo "Current containers:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            echo ""
            echo "Docker-compose status:"
            docker-compose ps || echo "docker-compose ps failed"
        '''
    }
}
        
        stage('‚úÖ Verify Deployment') {
            steps {
                sh '''
                    echo "Verifying deployment..."
                    
                    # Check if containers are running
                    echo "=== CONTAINER STATUS ==="
                    docker-compose ps
                    
                    # Check backend health
                    echo "Checking backend health..."
                    max_retries=10
                    retry_count=0
                    
                    while [ $retry_count -lt $max_retries ]; do
                        if curl -f http://localhost:4000/health 2>/dev/null; then
                            echo "‚úÖ Backend is healthy"
                            break
                        else
                            echo "‚ö†Ô∏è Backend not ready yet (attempt $((retry_count+1))/$max_retries)"
                            sleep 10
                            retry_count=$((retry_count+1))
                        fi
                    done
                    
                    if [ $retry_count -eq $max_retries ]; then
                        echo "‚ùå Backend health check failed after $max_retries attempts"
                        echo "Backend logs:"
                        docker-compose logs backend --tail=20
                    fi
                    
                    # Check frontend
                    echo "Checking frontend..."
                    if curl -I http://localhost:80 2>/dev/null; then
                        echo "‚úÖ Frontend is reachable"
                    else
                        echo "‚ö†Ô∏è Frontend not reachable"
                        echo "Frontend logs:"
                        docker-compose logs frontend --tail=20
                    fi
                    
                    # Check SonarQube
                    echo "Checking SonarQube..."
                    if curl -f http://localhost:9000 2>/dev/null; then
                        echo "‚úÖ SonarQube is running"
                    else
                        echo "‚ö†Ô∏è SonarQube not ready"
                    fi
                    
                    # Check Jenkins
                    echo "Checking Jenkins..."
                    if curl -f http://localhost:8081 2>/dev/null; then
                        echo "‚úÖ Jenkins is running"
                    else
                        echo "‚ö†Ô∏è Jenkins not ready"
                    fi
                    
                    echo "=== DEPLOYMENT VERIFICATION COMPLETE ==="
                '''
            }
        }
        
        stage('üîí Security Scan') {
            steps {
                sh '''
                    echo "Performing security scan..."
                    
                    if ! command -v trivy &> /dev/null; then
                        echo "Installing Trivy..."
                        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
                    fi
                    
                    echo "Scanning backend image..."
                    trivy image --severity HIGH,CRITICAL food-delivery-devsecops-backend:latest 2>/dev/null || echo "Security scan completed"
                    
                    echo "Scanning frontend image..."
                    trivy image --severity HIGH,CRITICAL food-delivery-devsecops-frontend:latest 2>/dev/null || echo "Security scan completed"
                '''
            }
        }
    }
    
    post {
        always {
            echo "=== PIPELINE COMPLETED ==="
            
            sh '''
                echo "Saving deployment logs..."
                docker-compose logs --tail=100 > deployment.log 2>&1 || true
                echo "Logs saved to deployment.log"
                
                echo "=== FINAL CONTAINER STATUS ==="
                docker-compose ps 2>/dev/null || docker ps --format "table {{.Names}}\t{{.Status}}"
            '''
            
            cleanWs()
        }
        success {
            echo "üéâüéâüéâ PIPELINE SUCCESSFUL! üéâüéâüéâ"
            echo ""
            echo "=== ACCESS URLs ==="
            echo "Frontend:     http://localhost:80"
            echo "Backend API:  http://localhost:4000"
            echo "SonarQube:    http://localhost:9000 (admin/admin)"
            echo "Jenkins:      http://localhost:8081"
            echo "Grafana:      http://localhost:3001 (admin/admin)"
            echo "Prometheus:   http://localhost:9090"
            echo ""
            echo "=== USEFUL COMMANDS ==="
            echo "View logs: docker-compose logs -f"
            echo "Stop services: docker-compose down"
            echo "Restart: docker-compose restart"
            echo ""
            echo "All DevSecOps services are running!"
        }
        failure {
            echo "‚ùå Pipeline failed"
            echo "Check the logs above for details."
            echo ""
            echo "=== TROUBLESHOOTING ==="
            echo "1. Check container logs: docker-compose logs"
            echo "2. Check running containers: docker ps"
            echo "3. Clean everything: docker system prune -af"
        }
    }
}